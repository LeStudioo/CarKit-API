name: Deploy to Production

on:
    push:
        branches: [ main ]
    workflow_dispatch:

env:
    NODE_ENV: production
    DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
    deploy:
        name: Deploy Application
        runs-on: ubuntu-latest
        environment: production

        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â±ï¸ Record start time
                id: start_time
                run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

            -   name: ðŸ’¬ Send Discord notification - Deploy Started
                run: |
                    COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1 | sed 's/"/\\"/g')
                    COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
                    COMMIT_SHA=$(git rev-parse --short HEAD)
                    
                    FIELDS=$(cat <<EOF
                    [
                      {"name": "ðŸ“ Commit", "value": "\`$COMMIT_SHA\` - $COMMIT_MSG", "inline": false},
                      {"name": "ðŸ‘¤ Author", "value": "$COMMIT_AUTHOR", "inline": true},
                      {"name": "ðŸŒ Environment", "value": "Production", "inline": true},
                      {"name": "ðŸ”— Workflow", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                    ]
                    EOF
                    )
                    
                    chmod +x .github/scripts/discord-notify.sh
                    .github/scripts/discord-notify.sh "$DISCORD_WEBHOOK" "deploy_start" "$FIELDS"

            -   name: ðŸš€ Deploy via SSH
                run: |
                    sshpass -p "${{ secrets.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
                    
                    echo "ðŸ”„ Stopping application..."
                    pm2 stop carkit-api || echo "App not running"
                    
                    echo "ðŸ“‚ Navigating to project directory..."
                    cd CarKit-API
                    
                    echo "ðŸ§¹ Cleaning workspace..."
                    git stash
                    git stash clear
                    
                    echo "â¬‡ï¸ Pulling latest changes..."
                    git pull origin main
                    
                    echo "ðŸ“¦ Installing dependencies..."
                    npm install
                    
                    echo "âœ… Starting application with PM2..."
                    pm2 start ecosystem.config.js
                    
                    echo "ðŸ’¾ Saving PM2 configuration..."
                    pm2 save
                    
                    echo "ðŸ“Š PM2 Status:"
                    pm2 status

            -   name: ðŸ“Š Get deployment info
                id: deploy_info
                if: success()
                run: |
                    VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
                    echo "version=$VERSION" >> $GITHUB_OUTPUT

            -   name: â±ï¸ Calculate duration
                id: duration
                if: always()
                run: |
                    END=$(date +%s)
                    START=${{ steps.start_time.outputs.start }}
                    DURATION=$((END - START))
                    MINUTES=$((DURATION / 60))
                    SECONDS=$((DURATION % 60))
                    echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

            -   name: ðŸ’¬ Send Discord notification - Deploy Success
                if: success()
                run: |
                    COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1 | sed 's/"/\\"/g')
                    COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
                    COMMIT_SHA=$(git rev-parse --short HEAD)
                    
                    FIELDS=$(cat <<EOF
                    [
                      {"name": "ðŸ“ Commit", "value": "\`$COMMIT_SHA\` - $COMMIT_MSG", "inline": false},
                      {"name": "ðŸ‘¤ Author", "value": "$COMMIT_AUTHOR", "inline": true},
                      {"name": "ðŸŒ Environment", "value": "Production", "inline": true},
                      {"name": "ðŸ“¦ Version", "value": "v${{ steps.deploy_info.outputs.version }}", "inline": true},
                      {"name": "â±ï¸ Deploy Time", "value": "${{ steps.duration.outputs.duration }}", "inline": true},
                      {"name": "ðŸ”— Workflow", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                    ]
                    EOF
                    )
                    
                    chmod +x .github/scripts/discord-notify.sh
                    .github/scripts/discord-notify.sh "$DISCORD_WEBHOOK" "deploy_success" "$FIELDS"

            -   name: ðŸ’¬ Send Discord notification - Deploy Failure
                if: failure()
                run: |
                    COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1 | sed 's/"/\\"/g')
                    COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
                    COMMIT_SHA=$(git rev-parse --short HEAD)
                    
                    FIELDS=$(cat <<EOF
                    [
                      {"name": "ðŸ“ Commit", "value": "\`$COMMIT_SHA\` - $COMMIT_MSG", "inline": false},
                      {"name": "ðŸ‘¤ Author", "value": "$COMMIT_AUTHOR", "inline": true},
                      {"name": "ðŸŒ Environment", "value": "Production", "inline": true},
                      {"name": "â±ï¸ Failed After", "value": "${{ steps.duration.outputs.duration }}", "inline": true},
                      {"name": "âŒ Error", "value": "Check the workflow logs for details", "inline": false},
                      {"name": "ðŸ”— Workflow", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                    ]
                    EOF
                    )
                    
                    chmod +x .github/scripts/discord-notify.sh
                    .github/scripts/discord-notify.sh "$DISCORD_WEBHOOK" "deploy_failure" "$FIELDS"